<!-- チャンネルの画面 -->
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>3-v-tuber</title>
        <script type="text/javascript" src="/js/jquery-3.3.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.7.1/pixi.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
        {% style "/assets/bootstrap/css/bootstrap.min.css" %}
        <link rel="stylesheet" href="/css/channel-style.css" type="text/css">
        <script type="text/javascript">
         // NOTICE

         // * how to invite another one?
         // webSocket.send(JSON.stringify({type : "invite",
         //                                name : <user-name>,
         //                                params : {key : <key>
         //                                          name : <another-name>}}));
         //    ** what is <key>?
         //         Please go to /swagger-ui
         //            and input https://elect-remote.softether.net/vchats-api/swagger.json into the top of form,
         //            and see default->/vchats-api/{channel}/invite
         //    ** if invitation is valid,
         //          we can get the json {type : invite, params : <another-name>}
         //

         // * how to accept invitation?
         // webSocket.send(JSON.stringify({type : "accept",
         //                                name : <user-name>}}));
         //    ** if accepting is valid,
         //          we can get the json {type : accept, params : <user-name>}

         // note -----------------------------------
         // - how to send face information
         // webSocket.send(JSON.stringify({type : "face", name : "owner",
         //                                params : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]}));
         // - how to send message
         // webSocket.send(JSON.stringify({type : "message",
         //                                name : "elect",
         //                                params : message}));
         //                  *  name : get from cookie
         // - how to send greeting (inform them login into the channel)
         // webSocket.send(JSON.stringify({type : "greeting",
         //                                name : "elect",
         //                                params : "hogehoge"}));
         // ----------------------------------------

         
         // -------------------------------------------------------------------
         // test
         var channel_name = (window.location.pathname).split("/")[2];
         // 接続先URI
         var uri = "wss://" + location.host + "/test/websocket/" + channel_name;
         console.log(uri);
         // WebSocketオブジェクト
         var webSocket = null;

         // 初期処理
         function init() {
             // ボタン押下イベント設定
             $("[data-name='message']").keypress(press);
             // 接続
             open();
         }

         // 接続
         function open() {
             if (webSocket == null) {
                 console.log("init websocket");
                 // WebSocket の初期化
                 webSocket = new WebSocket(uri);
                 console.log("initialized!");
                 console.log(webSocket);
                 // イベントハンドラの設定
                 webSocket.onopen = onOpen;
                 webSocket.onmessage = onMessage;
                 webSocket.onclose = onClose;
                 webSocket.onerror = onError;
             }
         }

         // 接続イベント
         function onOpen(event) {
             chat("<info> 接続しました");
             if (Cookies.get('identity')) {
                 webSocket.send(JSON.stringify({type : "greeting",
                                                name : Cookies.get('identity'),
                                                params : "チャンネルは" + channel_name}));
             }
         }

         // メッセージ受信イベント
         function onMessage(event) {
             if (event && event.data) {
                 //------------------------------------------------------------
                 var obj = JSON.parse(event.data);
                 console.log(obj.type);
                 if (obj.type == "voice-data") {
                     var voice = obj.params;
                     var audio = new Audio("data:audio/wav;base64," + voice);
                     audio.play();
                 }
                 else if(obj.type == "message"){
                     chat(event.data);
                 }
                 else if(obj.type == "close") {
                     chat(event.data);
                     window.location.replace("channels");
                 }
                 else if(obj.type == "invite") {
                     chat(event.data);
                 }
                 //-------------------------------------------------------------
                 // chat(event.data);
             }
         }

         // エラーイベント
         function onError(event) {
             chat("<info> エラーが発生しました。");
         }

         // 切断イベント
         function onClose(event) {
             chat("<info> 切断しました。3秒後に再接続します。(" + event.code + ")");
             webSocket = null;
             setTimeout("open()", 3000);
         }

         // キー押下時
         function press(event) {
             // キーがEnterか判定
             if (event && event.which == 13) {
                 // メッセージ取得
                 var message = $("[data-name='message']").val();
                 // 存在チェック
                 if (message && webSocket) {
                     // メッセージ送信
                     webSocket.send(
                         JSON.stringify({type : "message",
                                         name : Cookies.get('identity'),
                                         params : message}));
                     webSocket.send(
                         JSON.stringify({type : "talk",
                                         name : Cookies.get('identity'),
                                         params :{text : message}}));
                     // メッセージ初期化
                     $("[data-name='message']").val("");
                 }
             }
         }

         // チャットに表示
         function chat(message) {
             // 100件まで残す
             var chats = $("[data-name='chat']").find("div");
             while (chats.length >= 100) {
                 chats = chats.last().remove();
             }
             // メッセージ表示
             console.log("message" + message);
             var p = message.substring(0,1);
             if (p == "{") {
                 var msgtag = $("<div style=\"text-align:left;\">").text(JSON.parse(message).params);
             } else {
                 var msgtag = $("<div style=\"text-align:left;background-color:#ffdfdf\">").text(message);
             }
             $("[data-name='chat']").prepend(msgtag);
         }

         // 初期処理登録
         $(init);

         // close channel
         var close_name = "https://" + window.location.host + "/vchats-api/" + window.location.pathname.split("/")[2] +  "/close-channel";
         console.log(close_name);
         var btn =  document.querySelector('input[name=close-button]');
         var pass;
         var closeevent = function() {
             console.log("clicked");
             $.ajax({
                 url: close_name,
                 type: 'POST',
             }).done(function(data) {
                 alert("SUCCESS\n next: send messaage to websocket");
                 pass = data;
                 console.log (pass);
                 webSocket.send(JSON.stringify({type : "close",
                                                name : Cookies.get('identity'),
                                                params : pass}));
                 window.location.href = window.location.replace("channels");
             }).fail(function(XMLHttpRequest, testStatus,  errorThrown) {
                 alert("ERROR");
                 console.log(XMLHttpRequest);
                 console.log(testStatus);
                 console.log(errorThrown);
             })
         }

        </script>
    </head>

    <body>
        <div class="container mt-2">
            <div clas="row">
            <h1 id="title">Welcome to the channel</h1>
            </div>
        </div>
        <script>
         document.getElementById("title").innerHTML=window.location.pathname.split("/")[2];
        </script>
        <hr class="mt-0">

        <div style="margin:10px;width:900px">
            <div class="row">
                <div class="container" style="width:540px;margin:10px">
                    <div>
                        <canvas id="mydisplay-container" class="display-container" width="500px" height="400px" style="background-color:#636367;"></canvas>
                    </div>
                    <div id="oc">
                        <canvas id="opdisplay-container" class="display-container" width="500px" height=400px"  style="background-color:#636367;"></canvas>
                    </div>
                </div>
                
                <div class="container m-1 text-center" style="width:350px">
                    <div><h1>コメント</h1></div>
                    <div class="text-center">
                        <input type="text" data-name="message" size="100" style="width:320px">
                    </div>
                    <div class="log" data-name="chat" style="width:320px;height:720px;background-color:white;color:black"></div>
                </div>
            </div>
        </div>
        <hr>
        <div id="cc" class="container">
            <div class="raw text-center">
                <p>
                    <input class="close-btn" onclick="closeevent()" type="button" value="ライブを終了"></p>
            </div>
        </div>


        <!-- scripts and styles -->
        <script>
         // new -------------------------------------------------------------------
         // get channel user
         const talkers = new XMLHttpRequest();
         talkers.responseType = "json";
         var master;
         var slave;
         talkers.open("GET",window.location.protocol +"//" + window.location.host + "/vchats-api/" + window.location.pathname.split("/")[2] + "/get-talker");
         talkers.addEventListener("load",(event) => {

             console.log(event);
             if (200 ==  event.target.status) {
                 master = event.target.response["master"];
                 slave = event.target.response["inviter"];
                 if (Cookies.get('identity') != master) {
                     var eleme = document.getElementById("cc");
                     eleme.style.display = "none";
                 }
                 if (!slave) {
                     // goto below
                     var elem = document.getElementById("oc");
                     elem.style.display = "none";
                 }
             }
         });
         talkers.send();
        </script>
        {% style "/assets/font-awesome/web-fonts-with-css/css/fontawesome-all.min.css" %}

            {% script "/assets/jquery/jquery.min.js" %}
            {% script "/assets/font-awesome/svg-with-js/js/fontawesome.min.js" %}
            {% script "/assets/bootstrap/js/bootstrap.min.js" %}
        <script type="text/javascript">
         // ---------------------------------------------------
         // get-messages
         const request = new XMLHttpRequest();
         request.responseType="json";
         request.open("GET", "/vchats-api/"+ (window.location.pathname).split("/")[2] +"/get-messages");
         request.addEventListener("load", (event) => {
             console.log(event.target.status); // => 200
             console.log(event.target.response); // => "{...}"
             console.log(event.target.response["messages"].length); // => "{...}"
             event.target.response["messages"].slice().reverse().forEach(function(x) {
                 $("[data-name='chat']").prepend($("<div style=\"text-align:left;\">").text( "[" + x["name"]+"] " + x["params"]));
                 // console.log(x["params"] + "[" + x["name"]+"]");
             })
         });
         request.send();
         // ---------------------------------------------------

         // set canvas ----------------------------------------
         var width = 300;
         var height = 200;

         var stage = new PIXI.Stage(0x000000);

         var renderer = PIXI.autoDetectRenderer(width, height);

         document.getElementById("mydisplay-container").appendChild(renderer.view);

         function animate(){
             requestAnimationFrame(animate);
         }

         animate();
         // --------------------------------------------------------------
        </script>
            <script type="text/javascript">
             var csrfToken = "{{csrf-token}}";
            </script>
    </body>
</html>
